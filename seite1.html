<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WM-Tippspiel – Spiele & Tipps</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; text-align:center; background:#fff; color:#000; }
    .hero { width:100%; max-height:400px; object-fit:cover; display:block; }
    .cards { display:flex; justify-content:center; align-items:stretch; width:100%; }
    .card { flex:1; height:70px; background:#fff; color:#000; display:flex; justify-content:center; align-items:center;
            font-size:18px; text-decoration:none; border-top:2px solid #000; border-bottom:2px solid #000; border-left:2px solid #000; }
    .card:first-child { border-left:none; } .card:hover { background:#f5f5f5; }
    @media (max-width:768px){ .cards{ flex-direction:column; } .card{ border-left:none; border-top:2px solid #000; } .card:first-child{ border-top:none; } }
    .container { width:95%; max-width:1000px; margin: 24px auto 40px; }
    .title { font-size:2rem; font-weight:700; margin: 24px 0; }
    .match { background:#f7f7f7; border-radius:16px; box-shadow:0 3px 10px rgba(0,0,0,0.1); padding:20px; margin:16px 0; }
    .teams { display:flex; justify-content:space-between; align-items:center; font-weight:700; font-size:1.1rem; }
    .team { display:flex; flex-direction:column; align-items:center; }
    .flag { width:64px; height:42px; border-radius:4px; border:1px solid #ccc; object-fit:cover; margin-top:6px; }
    .meta { color:#666; margin:8px 0 12px; }
    .form { display:flex; align-items:center; justify-content:center; gap:14px; }
    .score { width:110px; height:64px; font-size:1.6rem; text-align:center; border-radius:10px; border:1px solid #bbb; }
    .saved { color:green; font-weight:700; margin-top:6px; display:none; }
    .locked { opacity:0.6; }
    .result { margin-top:10px; font-weight:700; }
    .error { color:#b00020; font-weight:700; margin:10px 0; }
    
/* Avatar + Admin FAB */
.user-avatar { position: fixed; top: 14px; left: 14px; width: 38px; height: 38px; border-radius: 50%; background:#fff; border:2px solid #000;
  display:flex; align-items:center; justify-content:center; font-weight:700; cursor:pointer; z-index:1000; box-shadow:0 3px 10px rgba(0,0,0,.12); }
.user-avatar:hover::after { content: attr(data-name); position:absolute; left: 46px; top: -2px; background:#000; color:#fff; font-size:12px; padding:4px 8px; border-radius:6px; white-space:nowrap; }
.fab-admin { position: fixed; right: 16px; bottom: 16px; width: 46px; height: 46px; border-radius: 10px; background:#fff; border:2px solid #000;
  display:flex; align-items:center; justify-content:center; text-decoration:none; color:#000; font-size:22px; z-index:1000; box-shadow: 0 4px 14px rgba(0,0,0,.14); }
.fab-admin:hover { background:#f5f5f5; }

  </style>
</head>
<body>
  <img class="hero" src="https://e6.365dm.de/23/05/2048x1152/skysport_de-fifa-wm-2026_6158884.jpg?20230518081555" alt="Hero"/>
  <div class="cards">
    <a class="card" href="seite1.html">Spiele</a>
    <a class="card" href="seite2.html">Rangliste</a>
    <a class="card" href="seite3.html">Regeln</a>
  </div>
  <div class="container">
    <div class="title">Tipps abgeben</div>
    <div id="err" class="error"></div>
    <div id="grid"></div>
  </div>
  
<script>
(function(){
  const API_BASE = (window.API_BASE_OVERRIDE || '') || (location.origin.startsWith('http') ? location.origin : 'http://localhost:3001');
  const STORAGE_TOKEN = 'tippspiel_token';
  const STORAGE_NAME = 'tippspiel_name';

  function initials(name){ if(!name) return '?'; const p=name.trim().split(/\s+/); return (p[0][0]+(p[1]?.[0]||'')).toUpperCase(); }
  function getName(){ return localStorage.getItem(STORAGE_NAME) || ''; }
  function getToken(){ return localStorage.getItem(STORAGE_TOKEN) || ''; }
  function setAuth(u){ if(u&&u.token){ localStorage.setItem(STORAGE_TOKEN,u.token); localStorage.setItem(STORAGE_NAME,u.name); updateAvatar(); } }
  function updateAvatar(){
    const av = document.getElementById('userAvatar'); if(!av) return;
    const name = getName() || 'Nicht angemeldet'; av.setAttribute('data-name', name); av.title = name;
    const span = av.querySelector('span'); if (span) span.textContent = initials(getName());
  }
  function ensureChrome(){
    if(!document.getElementById('userAvatar')){ const av=document.createElement('div'); av.id='userAvatar'; av.className='user-avatar'; av.innerHTML='<span>?</span>';
      av.addEventListener('click', ()=> { if(window.openLoginModal) window.openLoginModal(true); }); document.body.appendChild(av); }
    if(!document.getElementById('adminFab')){ const a=document.createElement('a'); a.id='adminFab'; a.className='fab-admin'; a.href='admin.html'; a.innerHTML='&#9881;'; a.setAttribute('aria-label','Admin'); document.body.appendChild(a); }
    updateAvatar();
  }
  function gate(){
    const isLogin = location.pathname.endsWith('/login.html') || location.pathname.endsWith('login.html');
    if (!getToken() && !isLogin) location.href = 'login.html';
  }
  window.tippspielCommon = { API_BASE, getName, getToken, setAuth, updateAvatar, ensureChrome, gate };
  ensureChrome(); gate();
})();
</script>

  <script>
    const API_BASE = tippspielCommon.API_BASE;
    const grid = document.getElementById('grid'); const err = document.getElementById('err');
    function getFlagUrl(code){ return `https://flagcdn.com/w80/${(code||'').toLowerCase()}.png`; }
    async function loadAll(){
      const [matches, myTips] = await Promise.all([loadMatches(), loadMyTipsSafe()]); render(matches, myTips);
    }
    async function loadMatches(){
      const res = await fetch(`${API_BASE}/api/matches`); if(!res.ok) throw new Error('Konnte Spiele nicht laden'); return res.json();
    }
    async function loadMyTipsSafe(){
      const t = tippspielCommon.getToken(); if (!t) return [];
      const res = await fetch(`${API_BASE}/api/my-tips`, { headers: { 'Authorization': `Bearer ${t}` } });
      if (!res.ok) return []; return res.json();
    }
    function tipFor(matchId, tips){ return tips.find(t => t.matchId === matchId) || { scoreA:'', scoreB:'' }; }
    function render(matches, tips){
      grid.innerHTML = '';
      matches.forEach(m => {
        const t = tipFor(m.id, tips); const id = `tip_${m.id}`; const kickoff = new Date(m.kickoff).toLocaleString();
        const locked = m.started; const resText = m.result ? `Resultat: ${m.result.a}:${m.result.b}` : '';
        const item = document.createElement('div'); item.className = 'match' + (locked ? ' locked':'');
        item.innerHTML = `
          <div class="teams">
            <div class="team"><span>${m.teamA}</span><img class="flag" src="${getFlagUrl(m.codeA)}" alt="${m.teamA}"/></div>
            <span>vs</span>
            <div class="team"><span>${m.teamB}</span><img class="flag" src="${getFlagUrl(m.codeB)}" alt="${m.teamB}"/></div>
          </div>
          <div class="meta">${m.stageLabel} • ${kickoff}</div>
          <div class="form">
            <input id="${id}_a" class="score" type="number" min="0" value="${t.scoreA !== '' ? t.scoreA : ''}" ${locked ? 'disabled':''} placeholder="0"/>
            <span>:</span>
            <input id="${id}_b" class="score" type="number" min="0" value="${t.scoreB !== '' ? t.scoreB : ''}" ${locked ? 'disabled':''} placeholder="0"/>
          </div>
          <div><button class="btn" ${locked ? 'disabled':''} onclick="saveTip('${m.id}')">Speichern</button></div>
          <div id="${id}_saved" class="saved">Tipp gespeichert ✓</div>
          <div class="result">${resText}</div>`;
        grid.appendChild(item);
      });
    }
    async function saveTip(matchId){
      const t = tippspielCommon.getToken(); if (!t) { err.textContent='Bitte zuerst anmelden.'; location.href='login.html'; return; }
      const id = `tip_${matchId}`; const a = parseInt(document.getElementById(`${id}_a`).value,10); const b = parseInt(document.getElementById(`${id}_b`).value,10);
      if (Number.isNaN(a)||Number.isNaN(b)||a<0||b<0) { err.textContent='Bitte gültige Zahlen (≥ 0)'; return; }
      try {
        const res = await fetch(`${API_BASE}/api/tips`, { method:'POST', headers: { 'Content-Type':'application/json', 'Authorization': `Bearer ${t}` },
          body: JSON.stringify({ matchId, scoreA:a, scoreB:b }) }); const data = await res.json(); if(!res.ok) throw new Error(data.error||'Speichern fehlgeschlagen');
        const saved = document.getElementById(`$ {id}_saved`.replace(' ','')); if(saved){ saved.style.display='block'; setTimeout(()=> saved.style.display='none', 1200); }
        err.textContent='';
      } catch(e) { err.textContent=e.message; }
    }
    loadAll();
  </script>
</body>
</html>
